#!/bin/sh

. ./testing.sh

catx()
{
	cat "$1" | sed 's/\\/\\\\/g'
	echo x
}

evsslgetcert_test()
{
	opt="$1"
	target="$2"
	name="$3"

	filebase=evsslgetcert-data/"evsslgetcert-$name"
	output="$filebase".out
	packets="$filebase".json
	export ATLAS_TESTS=yes ATLAS_UNSAFE=yes
	r=$( catx "$output" ); r=${r%?}
	testing "evsslgetcert-$name" "evsslgetcert $opt -R $packets $target" "$r" "" ""
}

evsslgetcert_test "-6" "atlas.ripe.json" "6"
evsslgetcert_test "-4" "atlas.ripe.json" "4"
evsslgetcert_test "-6 -A42" "atlas.ripe.json" "A42"
evsslgetcert_test "-6 -B43 -A42" "atlas.ripe.json" "B43"
evsslgetcert_test "-6 -h foo.example.com" "atlas.ripe.json" "h"
evsslgetcert_test "-6 -V TLS1.0 -h www.ripe.json" "www.ripe.json" "TLS1.0"
evsslgetcert_test "-4 -p 853" "8.8.8.8" "p853"

exit $FAILCOUNT

